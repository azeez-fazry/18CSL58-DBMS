/*  
	BOOK (BOOK_ID, TITLE, PUBLISHER_NAME, PUB_YEAR)
	BOOK_AUTHORS (BOOK_ID, AUTHOR_NAME)
	PUBLISHER (NAME, ADDRESS, PHONE) 
	BOOK_COPIES (BOOK_ID, BRANCH_ID, NO_OF_COPIES)
	BOOK_LENDING (BOOK_ID, BRANCH_ID, CARD_NO, DATE_OUT, DUE_DATE)
	LIBRARY_BRANCH (BRANCH_ID, BRANCH_NAME, ADDRESS)
	
	Write SQL queries to
	1. 	Retrieve details of all books in the library â€“ id, title, name of publisher, authors, number
		of copies in each branch,etc.
			
			SELECT B.BOOK_ID, B.TITLE, B.PUBLISHER_NAME, A.AUTHOR_NAME, C.NO_OF_COPIES,L.BRANCH_ID
			FROM BOOK B, BOOK_AUTHORS A, BOOK_COPIES C, LIBRARY_BRANCH L
			WHERE B.BOOK_ID=A.BOOK_ID AND B.BOOK_ID=C.BOOK_ID AND L.BRANCH_ID=C.BRANCH_ID;
			
			SELECT BOOK_ID,TITLE,PUBLISHER_NAME,AUTHOR_NAME,BRANCH_ID,NO_OF_COPIES
    		FROM BOOK NATURAL JOIN BOOK_AUTHORS NATURAL JOIN BOOK_COPIES;
			
	2. 	Get the particulars of borrowers who have borrowed more than 3 books, but from Jan
		Jan 2017 to Jun2017.
		
			SELECT CARD_NO
		    FROM BOOK_LENDING
		    WHERE DATE_OUT BETWEEN '2020-01-01' AND '2020-06-30' 
			HAVING COUNT(*)>3;
		
	3.	Delete a book in BOOK table. Update the contents of other tables to reflect this data
		manipulationoperation.
			
			DELETE FROM BOOK
			WHERE BOOK_ID=3; 
			
	4. 	Partition the BOOK table based on year of publication. Demonstrate its working with a
		simplequery.
		
			CREATE VIEW PUBLICATION AS
    		SELECT PUB_YEAR,BOOK_ID
    		FROM BOOK;
			SELECT * FROM PUBLICATION;
			 
	5. 	Create a view of all books and its number of copies that are currently available in the
		Library. 
		
			CREATE VIEW BOOKS_VIEW AS
			SELECT B.BOOK_ID, B.TITLE, C.NO_OF_COPIES
			FROM BOOK B, BOOK_COPIES C, LIBRARY_BRANCH L
			WHERE B.BOOK_ID=C.BOOK_ID AND C.BRANCH_ID=L.BRANCH_ID; 
			SELECT * FROM BOOKS_VIEW;
*/


DROP DATABASE IF EXISTS LAB1;
CREATE DATABASE LAB1;
USE LAB1;

DROP TABLE IF EXISTS PUBLISHER;
CREATE TABLE PUBLISHER (
	NAME VARCHAR (64) PRIMARY KEY,
	PHONE VARCHAR (10),
	ADDRESS VARCHAR (64)
); 

DROP TABLE IF EXISTS BOOK;
CREATE TABLE BOOK (
	BOOK_ID INT (10) PRIMARY KEY,
	TITLE VARCHAR(20),
	PUB_YEAR VARCHAR (20),
	PUBLISHER_NAME VARCHAR (20)
); 

DROP TABLE IF EXISTS BOOK_AUTHORS;
CREATE TABLE BOOK_AUTHORS (
	AUTHOR_NAME VARCHAR (20),
	BOOK_ID INT (10),
	PRIMARY KEY (BOOK_ID, AUTHOR_NAME)
);

DROP TABLE IF EXISTS LIBRARY_BRANCH;
CREATE TABLE LIBRARY_BRANCH (
	BRANCH_ID INT (10) PRIMARY KEY, 
	BRANCH_NAME VARCHAR(50),
	ADDRESS VARCHAR (50)
);

DROP TABLE IF EXISTS BOOK_COPIES;
CREATE TABLE BOOK_COPIES (
	NO_OF_COPIES INT (10),
	BOOK_ID INT (10),
	BRANCH_ID INT (10),
	PRIMARY KEY (BOOK_ID, BRANCH_ID)
);

DROP TABLE IF EXISTS BOOK_LENDING;
CREATE TABLE BOOK_LENDING (
	DATE_OUT DATE,
	DUE_DATE DATE,
	BOOK_ID INT (10),
	BRANCH_ID INT (10),
	CARD_NO INT (10),
	PRIMARY KEY (BOOK_ID, BRANCH_ID, CARD_NO)
);

ALTER TABLE BOOK ADD FOREIGN KEY (PUBLISHER_NAME) REFERENCES PUBLISHER (NAME) ON DELETE CASCADE;

ALTER TABLE BOOK_AUTHORS ADD FOREIGN KEY (BOOK_ID) REFERENCES BOOK (BOOK_ID) ON DELETE CASCADE;

ALTER TABLE BOOK_COPIES
	ADD FOREIGN KEY (BOOK_ID) REFERENCES BOOK (BOOK_ID) ON DELETE CASCADE,
	ADD FOREIGN KEY (BRANCH_ID) REFERENCES LIBRARY_BRANCH (BRANCH_ID) ON DELETE CASCADE;

ALTER TABLE BOOK_LENDING
	ADD FOREIGN KEY (BOOK_ID) REFERENCES BOOK (BOOK_ID) ON DELETE CASCADE,
	ADD FOREIGN KEY (BRANCH_ID) REFERENCES LIBRARY_BRANCH (BRANCH_ID) ON DELETE CASCADE;

INSERT INTO PUBLISHER VALUES ('MC PUB','9989076587', 'TUMKUR');
INSERT INTO PUBLISHER VALUES ('NANDHI','9889076565', 'BANGALORE');
INSERT INTO PUBLISHER VALUES ('PEARSON','7455679345', 'DAVANGERE'); 
INSERT INTO PUBLISHER VALUES ('STAR','8970862340', 'MYSORE');
INSERT INTO PUBLISHER VALUES ('SUDHA','7756120238','MYSORE'); 

INSERT INTO BOOK VALUES (1234,'DAATA STRUCTURE','2015','NANDHI'); 
INSERT INTO BOOK VALUES (1235,'COMPUTER NETWORKS','2010','NANDHI'); 
INSERT INTO BOOK VALUES (1236,'COMPUTER GRAPHICS','2011','SUDHA');
INSERT INTO BOOK VALUES (1237,'NETWORK SECURITY','2015','STAR'); 
INSERT INTO BOOK VALUES (1238,'LOGIC DESIGN','2016','MC PUB'); 

INSERT INTO BOOK_AUTHORS VALUES ('RAGUNANDAN', 1234); 
INSERT INTO BOOK_AUTHORS VALUES ('ALBERT',1235); 
INSERT INTO BOOK_AUTHORS VALUES ('JOHN',1236); 
INSERT INTO BOOK_AUTHORS VALUES ('STEVEN',1236); 
INSERT INTO BOOK_AUTHORS VALUES ('STALLING',1237); 
INSERT INTO BOOK_AUTHORS VALUES ('KIRAN',1238); 

INSERT INTO LIBRARY_BRANCH VALUES (201,'MAIN','GOKULAM MYSORE'); 
INSERT INTO LIBRARY_BRANCH VALUES (202,'RR BRANCH','RR 5TH BLOCK');
INSERT INTO LIBRARY_BRANCH VALUES (203,'VN BRANCH NAGAR', 'VIJAY NAGAR'); 
INSERT INTO LIBRARY_BRANCH VALUES (204,'CITY','RICHMOND ROAD');
INSERT INTO LIBRARY_BRANCH VALUES (205,'CITY','RICHMOND ROAD'); 
INSERT INTO LIBRARY_BRANCH VALUES (206,'JAYANAGAR','1ST BLOCK JAYANAGAR'); 

INSERT INTO BOOK_COPIES VALUES (15,1234,201);
INSERT INTO BOOK_COPIES VALUES (10,1234,202);
INSERT INTO BOOK_COPIES VALUES (13,1235,203);
INSERT INTO BOOK_COPIES VALUES (10,1235,206);
INSERT INTO BOOK_COPIES VALUES (11,1236,205);
INSERT INTO BOOK_COPIES VALUES (7,1236,202);
INSERT INTO BOOK_COPIES VALUES (8,1237,205);
INSERT INTO BOOK_COPIES VALUES (12,1288,201);

INSERT INTO BOOK_LENDING VALUES ('2017-05-12','2017-05-27',1234,201, 11);
INSERT INTO BOOK_LENDING VALUES ('2020-05-16','2020-06-01',1234,201, 44);
INSERT INTO BOOK_LENDING VALUES ('2017-05-30','2017-06-15',1235,203, 11);
INSERT INTO BOOK_LENDING VALUES ('2017-08-02','2017-08-17',1236,202, 11);
INSERT INTO BOOK_LENDING VALUES ('2019-04-25','2019-05-14',1237,205, 22);
INSERT INTO BOOK_LENDING VALUES ('2017-09-01','2017-09-15',1238,201, 11);
INSERT INTO BOOK_LENDING VALUES ('2017-04-20','2017-05-05',1238,201, 33);
